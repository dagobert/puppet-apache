# File managed by Tiny Puppet
# Template derived from puppetlabs-apahe module

ServerTokens <%= @options@['server_tokens'] %>
ServerSignature <%= scope.function_bool2httpd(@options['server_signature']) %>
TraceEnable <%= scope.function_bool2httpd(@options['trace_enable']) %>

ServerName "<%= @options['servername'] %>"
ServerRoot "<%= @options['server_root'] %>"
PidFile <%= @options['pidfile'] %>
Timeout <%= @options['timeout'] %>
KeepAlive <%= @options['keepalive'] %>
MaxKeepAliveRequests <%= @options['max_keepalive_requests'] %>
KeepAliveTimeout <%= @options['keepalive_timeout'] %>
LimitRequestFieldSize <%= @options['limitreqfieldsize'] %>

<%- if @options['rewrite_lock'] and scope.function_versioncmp([@options['apache_version'], '2.2']) <= 0 -%>
RewriteLock <%= @options['rewrite_lock'] %>
<%- end -%>

User <%= @options['user'] %>
Group <%= @options['group'] %>

AccessFileName .htaccess
<FilesMatch "^\.ht">
<%- if scope.function_versioncmp([@options['apache_version'], '2.4']) >= 0 -%>
    Require all denied
<%- else -%>
     Order allow,deny
     Deny from all
     Satisfy all
<%- end -%>
</FilesMatch>

<Directory />
  Options <%= Array(@options['root_directory_options']).join(' ') %>
  AllowOverride None
</Directory>

<% if @options['default_charset'] -%>
AddDefaultCharset <%= @options['default_charset'] %>
<% end -%>

<%- if scope.function_versioncmp([@options['apache_version'], '2.4']) < 0 -%>
DefaultType <%= @options['default_type'] %>
<%- end -%>
HostnameLookups Off
ErrorLog "<%= @options['logroot'] %>/<%= @options['error_log'] %>"
LogLevel <%= @options['log_level'] %>
EnableSendfile <%= @options['sendfile'] %>
<%- if @options['allow_encoded_slashes'] -%>
AllowEncodedSlashes <%= @options['allow_encoded_slashes'] %>
<%- end -%>

#Listen 80

<% if @options['apxs_workaround'] -%>
# Workaround: without this hack apxs would be confused about where to put
# LoadModule directives and fail entire procedure of apache package
# installation/reinstallation. This problem was observed on FreeBSD (apache22).
#LoadModule fake_module libexec/apache22/mod_fake.so
<% end -%>

Include "<%= @options['mod_load_dir'] %>/*.load"
<% if @options['mod_load_dir'] != @options['confd_dir'] and @options['mod_load_dir'] != @options['vhost_load_dir'] -%>
Include "<%= @options['mod_load_dir'] %>/*.conf"
<% end -%>
Include "<%= @options['ports_file'] %>"

<% unless @options['log_formats'].has_key?('combined') -%>
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
<% end -%>
<% unless @options['log_formats'].has_key?('common') -%>
LogFormat "%h %l %u %t \"%r\" %>s %b" common
<% end -%>
<% unless @options['log_formats'].has_key?('referer') -%>
LogFormat "%{Referer}i -> %U" referer
<% end -%>
<% unless @options['log_formats'].has_key?('agent') -%>
LogFormat "%{User-agent}i" agent
<% end -%>
<% unless @options['log_formats'].has_key?('forwarded') -%>
LogFormat "%{X-Forwarded-For}i %l %u %t \"%r\" %s %b \"%{Referer}i\" \"%{User-agent}i\"" forwarded
<% end -%>
<% if @options['log_formats'] and !@options['log_formats'].empty? -%>
  <%- @options['log_formats'].sort.each do |nickname,format| -%>
LogFormat "<%= format -%>" <%= nickname %>
  <%- end -%>
<% end -%>

<%- if scope.function_versioncmp([@options['apache_version'], '2.4']) >= 0 -%>
IncludeOptional "<%= @options['confd_dir'] %>/*.conf"
<%- else -%>
Include "<%= @options['confd_dir'] %>/*.conf"
<%- end -%>
<% if @options['vhost_load_dir'] != @options['confd_dir'] -%>
<%- if scope.function_versioncmp([@options['apache_version'], '2.4']) >= 0 -%>
IncludeOptional "<%= @options['vhost_load_dir'] %>/<%= @options['vhost_include_pattern'] %>"
<%- else -%>
Include "<%= @options['vhost_load_dir'] %>/<%= @options['vhost_include_pattern'] %>"
<%- end -%>
<% end -%>

<% if @options['error_documents'] -%>
# /usr/share/apache2/error on debian
Alias /error/ "<%= @options['error_documents_path'] %>/"

<Directory "<%= @options['error_documents_path'] %>">
  AllowOverride None
  Options IncludesNoExec
  AddOutputFilter Includes html
  AddHandler type-map var
<%- if scope.function_versioncmp([@options['apache_version'], '2.4']) >= 0 -%>
  Require all granted
<%- else -%>
  Order allow,deny
  Allow from all
<%- end -%>
  LanguagePriority en cs de es fr it nl sv pt-br ro
  ForceLanguagePriority Prefer Fallback
</Directory>

ErrorDocument 400 /error/HTTP_BAD_REQUEST.html.var
ErrorDocument 401 /error/HTTP_UNAUTHORIZED.html.var
ErrorDocument 403 /error/HTTP_FORBIDDEN.html.var
ErrorDocument 404 /error/HTTP_NOT_FOUND.html.var
ErrorDocument 405 /error/HTTP_METHOD_NOT_ALLOWED.html.var
ErrorDocument 408 /error/HTTP_REQUEST_TIME_OUT.html.var
ErrorDocument 410 /error/HTTP_GONE.html.var
ErrorDocument 411 /error/HTTP_LENGTH_REQUIRED.html.var
ErrorDocument 412 /error/HTTP_PRECONDITION_FAILED.html.var
ErrorDocument 413 /error/HTTP_REQUEST_ENTITY_TOO_LARGE.html.var
ErrorDocument 414 /error/HTTP_REQUEST_URI_TOO_LARGE.html.var
ErrorDocument 415 /error/HTTP_UNSUPPORTED_MEDIA_TYPE.html.var
ErrorDocument 500 /error/HTTP_INTERNAL_SERVER_ERROR.html.var
ErrorDocument 501 /error/HTTP_NOT_IMPLEMENTED.html.var
ErrorDocument 502 /error/HTTP_BAD_GATEWAY.html.var
ErrorDocument 503 /error/HTTP_SERVICE_UNAVAILABLE.html.var
ErrorDocument 506 /error/HTTP_VARIANT_ALSO_VARIES.html.var
<% end -%>
